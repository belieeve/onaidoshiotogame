var f=Object.defineProperty;var u=(c,t,e)=>t in c?f(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var o=(c,t,e)=>u(c,typeof t!="symbol"?t+"":t,e);import{C as g,T as h,G as l,_ as p,l as w,s as y}from"./index-CmMHvc-L.js";class k{constructor(){o(this,"stage",new g);o(this,"app");o(this,"change");o(this,"ctx",new(window.AudioContext||window.webkitAudioContext));o(this,"clicks",[]);o(this,"taps",[]);o(this,"running",!1);o(this,"info");o(this,"avgMs",0);o(this,"onKey",t=>{(t.key.toLowerCase()==="enter"||t.key.toLowerCase()===" ")&&this.captureTap()});o(this,"onTap",()=>{this.captureTap()})}async init(){this.app.stage.addChild(this.stage);const t=new h({text:"キャリブレーション",style:{fill:16777215,fontSize:28}});t.x=24,t.y=24,this.stage.addChild(t),this.info=new h({text:"説明: クリック音に合わせて画面をタップ/Enter。8回以上で精度UP。",style:{fill:13421823,fontSize:16}}),this.info.x=24,this.info.y=64,this.stage.addChild(this.info);const e=new l().roundRect(24,100,160,44,10).fill(4473946),n=new h({text:"戻る",style:{fill:16777215,fontSize:16}});n.x=40,n.y=112,e.eventMode="static",e.cursor="pointer",e.on("pointertap",async()=>{const a=await p(()=>import("./index-CmMHvc-L.js").then(r=>r.au),[],import.meta.url);this.change(new a.SettingsScene)}),this.stage.addChild(e,n);const i=new l().roundRect(200,100,200,44,10).fill(2849323),s=new h({text:"推定を適用",style:{fill:16777215,fontSize:16}});s.x=240,s.y=112,i.eventMode="static",i.cursor="pointer",i.on("pointertap",()=>this.apply()),this.stage.addChild(i,s),window.addEventListener("keydown",this.onKey),this.stage.eventMode="static",this.stage.on("pointerdown",this.onTap),this.running=!0,this.scheduleClicks()}update(){if(!this.running)return;const t=this.app.renderer.width;this.app.renderer.height;const n=this.ctx.currentTime%.6/.6,i=20+10*Math.sin(n*Math.PI*2),s=new l().circle(t-60,60,i).fill(16732120);this.stage.addChild(s),queueMicrotask(()=>s.destroy())}dispose(){this.running=!1,window.removeEventListener("keydown",this.onKey),this.stage.off("pointerdown",this.onTap),this.stage.removeFromParent(),this.stage.destroy({children:!0})}scheduleClicks(){const t=this.makeClick(),e=this.ctx.currentTime+.5,n=.6;for(let i=0;i<32;i++){const s=e+i*n,a=this.ctx.createBufferSource();a.buffer=t,a.connect(this.ctx.destination),a.start(s),this.clicks.push(s)}}makeClick(){const t=this.ctx.sampleRate,e=Math.floor(t*.05),n=this.ctx.createBuffer(1,e,t),i=n.getChannelData(0);for(let s=0;s<e;s++){const a=s/t;i[s]=Math.exp(-50*a)}return n}captureTap(){const t=this.ctx.currentTime;this.taps.push(t);let e=this.clicks[0],n=1/0;for(const r of this.clicks){const d=Math.abs(r-t);d<n&&(n=d,e=r)}const i=t-e,s=Math.round(i*1e3),a=this.taps.length;this.avgMs=Math.round((this.avgMs*(a-1)+s)/a),this.info.text=`サンプル: ${a}  平均ラグ: ${this.avgMs}ms  推奨オフセット: ${-this.avgMs}ms`}apply(){const t=w();t.offsetMs=-this.avgMs,y(t),p(()=>import("./index-CmMHvc-L.js").then(e=>e.au),[],import.meta.url).then(e=>this.change(new e.SettingsScene))}}export{k as CalibrationScene};
//# sourceMappingURL=CalibrationScene-BRWJ3wZP.js.map
